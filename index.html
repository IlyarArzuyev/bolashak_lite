<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <title>–ü—Ä–∏—ë–º –∑–∞—è–≤–æ–∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f3f4f6;
            color: #111827;
            height: 100vh;
            overflow: hidden;
        }

        .app {
            height: 100vh;
            max-width: 480px;
            margin: 0 auto;
            position: relative; /* –í–∞–∂–Ω–æ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫—Ä–∞–Ω–æ–≤ */
        }

        header {
            background: #111827;
            color: #fff;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            z-index: 100;
            height: 72px;
            box-sizing: border-box;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
        }

        header span {
            font-size: 11px;
            opacity: 0.8;
        }

        /* –≠–ö–†–ê–ù–´ - –ü–û–õ–ù–û–†–ê–ó–ú–ï–†–ù–´–ï */
        .screen {
            display: none;
            position: fixed;
            top: 72px; /* –í—ã—Å–æ—Ç–∞ header */
            bottom: 90px; /* –í—ã—Å–æ—Ç–∞ bottom-bar */
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            overflow-y: auto;
            padding: 12px;
            background: #f3f4f6;
            z-index: 1;
        }

        .screen.active {
            display: block;
        }

        /* –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ */
        #home-screen {
            display: block;
        }

        /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ—Ç—Å—Ç—É–ø—ã —É main */
        main {
            position: fixed;
            top: 72px;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            overflow-y: auto;
            padding: 12px;
            background: #f3f4f6;
            z-index: 1;
        }

        .section {
            background: #fff;
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-title small {
            font-size: 11px;
            font-weight: 400;
            color: #6b7280;
        }

        label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
            color: #4b5563;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            font-size: 13px;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
            background: #f9fafb;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.1);
            background: #ffffff;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .field-row {
            display: flex;
            gap: 8px;
        }

        .field-row > div {
            flex: 1;
        }

        .date-type-row {
            display: flex;
            gap: 30px;
        }

        .date-type-row .date-col {
            flex: 0 0 50%;
        }

        .date-type-row .type-col {
            flex: 0 0 40%;
        }

        @media (max-width: 360px) {
            .date-type-row .date-col {
                flex: 0 0 55%;
            }
            .date-type-row .type-col {
                flex: 0 0 45%;
            }
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 6px;
            border-radius: 999px;
            font-size: 10px;
            background: #e5f0ff;
            color: #1d4ed8;
        }

        .products-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 220px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .product-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }

        .product-info {
            flex: 1;
            margin-right: 10px;
        }

        .product-name {
            font-size: 13px;
            font-weight: 500;
        }

        .product-meta {
            font-size: 11px;
            color: #6b7280;
        }

        .product-price {
            font-size: 11px;
            font-weight: 500;
        }

        .qty-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 72px;
        }

        .qty-btn {
            border: none;
            border-radius: 999px;
            width: 24px;
            height: 24px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111827;
            color: #fff;
        }

        .qty-display {
            font-size: 12px;
            padding: 3px 6px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            min-width: 40px;
            text-align: center;
            background: #fff;
        }

        .cart-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            padding: 6px 8px;
            border-radius: 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }

        .cart-item-main {
            display: flex;
            flex-direction: column;
        }

        .cart-item-name {
            font-weight: 500;
        }

        .cart-item-meta {
            font-size: 11px;
            color: #6b7280;
        }

        .cart-item-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .cart-item-price {
            font-size: 11px;
            font-weight: 600;
        }

        .cart-delete {
            border: none;
            background: none;
            font-size: 11px;
            color: #ef4444;
            padding: 0;
        }

        .cart-empty {
            font-size: 12px;
            color: #9ca3af;
        }

        .cart-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .chip-row {
            display: flex;
            gap: 6px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .chip {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
        }

        /* –ö–æ—Ä–∑–∏–Ω–∞ (—ç–∫—Ä–∞–Ω) */
        .draft-orders-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .draft-order-card {
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
        }

        .draft-order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .draft-order-title {
            font-size: 13px;
            font-weight: 600;
        }

        .draft-order-date {
            font-size: 11px;
            color: #6b7280;
        }

        .draft-order-client {
            font-size: 12px;
            margin-bottom: 8px;
        }

        .draft-order-items {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .draft-order-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }

        .btn-secondary {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 11px;
            background: #fff;
            color: #111827;
        }

        .btn-danger {
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 11px;
            background: #fef2f2;
            color: #dc2626;
        }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-order-card {
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
        }

        .history-order-status {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .status-sent {
            background: #dcfce7;
            color: #166534;
        }

        .history-order-details {
            font-size: 11px;
            color: #6b7280;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 16px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            border: none;
            background: none;
            font-size: 20px;
            color: #6b7280;
        }

        .modal-section {
            margin-bottom: 12px;
        }

        .modal-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .modal-value {
            font-size: 14px;
        }

        /* –ú–∞–≥–∞–∑–∏–Ω */
        .shop-info {
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            margin-top: 12px;
        }

        .shop-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* –ù–ò–ñ–ù–ò–ô –ë–ê–† –° –ù–ê–í–ò–ì–ê–¶–ò–ï–ô */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: #fff;
            border-top: 1px solid #e5e7eb;
            padding: 8px 12px;
            z-index: 100;
            display: flex;
            justify-content: space-around;
            height: 90px;
            box-sizing: border-box;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: none;
            background: none;
            padding: 6px 12px;
            font-size: 10px;
            color: #6b7280;
            gap: 4px;
            flex: 1;
        }

        .nav-btn.active {
            color: #2563eb;
        }

        .nav-icon {
            font-size: 18px;
        }

        .nav-badge {
            position: absolute;
            top: -2px;
            right: 8px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 999px;
            min-width: 16px;
        }

        .btn-primary {
            border: none;
            border-radius: 999px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: #16a34a;
            color: #fff;
            white-space: nowrap;
            min-width: 120px;
        }

        .btn-primary:disabled {
            opacity: 0.5;
        }

    </style>

</head>
<body>
<div class="app">
    <header>
        <div style="display:flex;align-items:center;gap:10px;">
            <img id="tgAvatar" alt="avatar"
                 style="width:34px;height:34px;border-radius:999px;object-fit:cover;background:#374151;display:none;">
            <div>
                <h1 style="margin:0;font-size:18px;line-height:1.1;" id="screen-title">–ü—Ä–∏—ë–º –∑–∞—è–≤–æ–∫</h1>
                <span id="tgNick" style="font-size:11px;opacity:.85;">–ì–æ—Å—Ç—å</span>
            </div>
        </div>

        <div style="font-size:11px;text-align:right;">
            <div id="repName">–¢–û–û –ë–æ–ª–∞—à–∞–∫</div>
            <div id="todayDate"></div>
        </div>
    </header>

    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏) -->
    <main id="home-screen" class="screen active">
        <!-- –î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê -->
        <section class="section">
            <div class="section-title">
                –ö–ª–∏–µ–Ω—Ç
                <span class="badge">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</span>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <div>
                    <label for="clientName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏</label>
                    <input id="clientName" type="text" placeholder="–ú–∞–≥–∞–∑–∏–Ω ¬´–ü—Ä–∏–º–µ—Ä¬ª">
                </div>
                <div>
                    <label for="clientCode">–ò–ü —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏</label>
                    <input id="clientCode" type="text" placeholder="–ò–ü ¬´–ü—Ä–∏–º–µ—Ä¬ª">
                </div>
                <div>
                    <label for="clientAddress">–†–ù</label>
                    <input id="clientAddress" type="text" placeholder="–†–ù ¬´–ü—Ä–∏–º–µ—Ä¬ª">
                </div>
                <div class="field-row date-type-row">
                    <div class="date-col">
                        <label for="deliveryDate">–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏</label>
                        <input id="deliveryDate" type="date">
                    </div>
                    <div class="type-col">
                        <label for="deliveryType">–¢–∏–ø –∑–∞—è–≤–∫–∏</label>
                        <select id="deliveryType">
                            <option value="today">–í –¥–µ–Ω—å</option>
                            <option value="tomorrow">–ù–∞ –∑–∞–≤—Ç—Ä–∞</option>
                            <option value="schedule">–ü–æ –≥—Ä–∞—Ñ–∏–∫—É</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- –í–´–ë–û–† –¢–û–í–ê–†–ê -->
        <section class="section">
            <div class="section-title">
                –¢–æ–≤–∞—Ä—ã
                <small>–ù–∞–∂–º–∏—Ç–µ + –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∑–∞—è–≤–∫—É</small>
            </div>

            <div class="field-row" style="margin-bottom:8px;">
                <div>
                    <label for="categoryFilter">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="categoryFilter">
                        <option value="all">–í—Å–µ</option>
                    </select>
                </div>
                <div>
                    <label for="searchProduct">–ü–æ–∏—Å–∫</label>
                    <input id="searchProduct" type="text" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ">
                </div>
            </div>

            <div class="products-list" id="productsList">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
            </div>
        </section>

        <!-- –ö–û–†–ó–ò–ù–ê –ù–ê –ì–õ–ê–í–ù–û–ô -->
        <section class="section">
            <div class="section-title">
                –¢–µ–∫—É—â–∞—è –∑–∞—è–≤–∫–∞
                <small>–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ</small>
            </div>
            <div id="cartList" class="cart-list">
                <div class="cart-empty">–¢–æ–≤–∞—Ä—ã –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.</div>
            </div>
            <div class="cart-summary" id="cartSummary" style="display:none;">
                <div>–ò—Ç–æ–≥–æ –ø–æ–∑–∏—Ü–∏–π: <span id="totalItems">0</span></div>
                <div>–°—É–º–º–∞: <span id="totalAmount">0</span> ‚Ç∏</div>
            </div>
            <div class="chip-row">
                <div class="chip">–í—Å–µ–≥–æ: <span id="totalQty">0</span> —à—Ç</div>
            </div>
        </section>

        <!-- –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û -->
        <section class="section">
            <div class="section-title">
                –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <div>
                    <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞—è–≤–∫–µ</label>
                    <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–≥—Ä—É–∑–∫–∞ —Å –∑–∞–¥–Ω–µ–≥–æ –¥–≤–æ—Ä–∞, –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ, –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã"></textarea>
                </div>
            </div>
        </section>

        <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô –ù–ê –ì–õ–ê–í–ù–û–ô -->
        <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button type="button" class="btn-primary" id="saveToCartBtn" disabled style="background: #2563eb;">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
            </button>
            <button type="button" class="btn-secondary" id="clearFormBtn">
                –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
            </button>
        </div>
    </main>

    <!-- –≠–∫—Ä–∞–Ω –º–∞–≥–∞–∑–∏–Ω–∞ -->
    <div id="shop-screen" class="screen">
        <div class="shop-info">
            <div class="shop-icon">üè™</div>
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–≥–∞–∑–∏–Ω–∞—Ö</h3>
            <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">
                –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–≥–∞–∑–∏–Ω–∞—Ö –∏ –∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö.
            </p>
            <p style="font-size: 12px; color: #9ca3af; margin-top: 12px;">
                –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
            </p>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∫–æ—Ä–∑–∏–Ω—ã (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∏) -->
    <div id="cart-screen" class="screen">
        <div class="section">
            <div class="section-title">
                –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –∑–∞—è–≤–æ–∫
                <small>–°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
            </div>
            <div id="draftOrdersList" class="draft-orders-list">
                <div class="cart-empty">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>
            </div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div id="history-screen" class="screen">
        <div class="section">
            <div class="section-title">
                –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫
                <small>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏</small>
            </div>
            <div id="historyOrdersList" class="history-list">
                <div class="cart-empty">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞—è–≤–∫–∏ -->
    <div id="orderDetailsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏</div>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div id="modalContent">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
            </div>
        </div>
    </div>

    <!-- –ù–ò–ñ–ù–ò–ô –ë–ê–† –° –ù–ê–í–ò–ì–ê–¶–ò–ï–ô -->
    <div class="bottom-bar">
        <button class="nav-btn active" data-screen="home">
            <span class="nav-icon">üè†</span>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button class="nav-btn" data-screen="shop">
            <span class="nav-icon">üè™</span>
            <span>–ú–∞–≥–∞–∑–∏–Ω</span>
        </button>
        <button class="nav-btn" data-screen="cart">
            <span class="nav-icon">üõí</span>
            <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
            <span id="cartBadge" class="nav-badge" style="display: none;">0</span>
        </button>
        <button class="nav-btn" data-screen="history">
            <span class="nav-icon">üìã</span>
            <span>–ò—Å—Ç–æ—Ä–∏—è</span>
        </button>
    </div>
</div>

<script>
    // ====== –ù–ê–°–¢–†–û–ô–ö–ò API ======
    const PRODUCTS_API_URL = 'https://script.google.com/macros/s/AKfycbyzxmamE7twcF98CSwcdHEuQF-Q10NkXJiJ1K9oNEvRUfuXtmZzn7EKL3veoDPrS4BC2Q/exec';
    const ORDER_WEBHOOK_URL = 'https://n8n-n8n.sbifer.easypanel.host/webhook/db43e1b5-3a35-45e6-b625-81f03d141629';

    let products = [];
    const cart = {};
    let tgUser = null;
    let tgInitData = '';
    let currentDraftId = null;
    
    document.addEventListener('DOMContentLoaded', () => {
        initTodayDate();
        setupEvents();
        initTelegramUser();
        setupTapToBlur();
        initNavigation();
        loadDraftOrders();
        loadHistoryOrders();

        loadProducts().then(() => {
            populateCategories();
            renderProducts();
            updateUI();
        }).catch(() => {
            renderProducts();
            updateUI();
        });
    });

    function initTelegramUser() {
        if (!window.Telegram || !Telegram.WebApp) {
            console.warn('Telegram WebApp SDK –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram?');
            return;
        }

        const tg = Telegram.WebApp;
        tg.ready();
        tg.expand();

        tgInitData = tg.initData || '';
        tgUser = tg.initDataUnsafe?.user || null;

        const nickEl = document.getElementById('tgNick');
        const avatarEl = document.getElementById('tgAvatar');

        if (tgUser) {
            const displayName =
                tgUser.username ? '@' + tgUser.username :
                [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

            if (nickEl) nickEl.textContent = displayName;

            if (avatarEl && tgUser.photo_url) {
                avatarEl.src = tgUser.photo_url;
                avatarEl.style.display = 'block';
            }
        }
    }
    
    function setupTapToBlur() {
        ['touchstart', 'mousedown'].forEach(evtName => {
            document.addEventListener(evtName, (event) => {
                const active = document.activeElement;
                if (!active) return;

                const tag = active.tagName.toLowerCase();
                const isInputLike = ['input', 'textarea', 'select'].includes(tag);

                if (!isInputLike) return;
                if (event.target.closest('input, textarea, select')) return;

                active.blur();
            }, { passive: true });
        });
    }

    // ====== –ù–ê–í–ò–ì–ê–¶–ò–Ø ======
    function initNavigation() {
        const navButtons = document.querySelectorAll('.nav-btn');
        const screens = document.querySelectorAll('.screen');
        const screenTitle = document.getElementById('screen-title');

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const screenId = btn.getAttribute('data-screen');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                navButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
                screens.forEach(screen => screen.classList.remove('active'));
                document.getElementById(`${screenId}-screen`).classList.add('active');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                const titles = {
                    'home': '–ü—Ä–∏—ë–º –∑–∞—è–≤–æ–∫',
                    'shop': '–ú–∞–≥–∞–∑–∏–Ω—ã',
                    'cart': '–ö–æ—Ä–∑–∏–Ω–∞',
                    'history': '–ò—Å—Ç–æ—Ä–∏—è'
                };
                screenTitle.textContent = titles[screenId];
            });
        });
    }

    // ====== –†–ê–ë–û–¢–ê –° –õ–û–ö–ê–õ–¨–ù–´–ú –•–†–ê–ù–ò–õ–ò–©–ï–ú ======
    function getDraftOrders() {
        const orders = localStorage.getItem('draftOrders');
        return orders ? JSON.parse(orders) : [];
    }

    function saveDraftOrders(orders) {
        localStorage.setItem('draftOrders', JSON.stringify(orders));
        updateCartBadge();
    }

    function getHistoryOrders() {
        const orders = localStorage.getItem('historyOrders');
        return orders ? JSON.parse(orders) : [];
    }

    function saveHistoryOrders(orders) {
        localStorage.setItem('historyOrders', JSON.stringify(orders));
    }

    function updateCartBadge() {
        const drafts = getDraftOrders();
        const badge = document.getElementById('cartBadge');
        if (drafts.length > 0) {
            badge.textContent = drafts.length;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }

    // ====== –ó–ê–ì–†–£–ó–ö–ê –¢–û–í–ê–†–û–í ======
    async function loadProducts() {
        try {
            const res = await fetch(PRODUCTS_API_URL);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();

            products = (data.products || []).map(p => ({
                id: String(p.id),
                name: String(p.name),
                price: Number(p.price) || 0,
                category: (p.category || '').toLowerCase(),
                packType: 'unit',
                unitsPerCase: 1
            }));

            console.log('–¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Google Sheets:', products);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Google Sheets:', err);
            alert('–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ë–î.');
            products = [];
        }
    }

    function populateCategories() {
        const select = document.getElementById('categoryFilter');
        if (!select) return;

        select.innerHTML = '<option value="all">–í—Å–µ</option>';

        const categoriesSet = new Set();

        products.forEach(p => {
            const cat = (p.category || '').trim();
            if (!cat) return;
            categoriesSet.add(cat);
        });

        Array.from(categoriesSet).sort().forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = formatCategoryLabel(cat);
            select.appendChild(opt);
        });
    }

    function formatCategoryLabel(cat) {
        if (!cat) return '';
        return cat.charAt(0).toUpperCase() + cat.slice(1);
    }

    function initTodayDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('todayDate').textContent = `${dd}.${mm}.${yyyy}`;
        document.getElementById('deliveryDate').value = `${yyyy}-${mm}-${dd}`;
    }

    // ====== –°–û–ë–´–¢–ò–Ø ======
    function setupEvents() {
        document.getElementById('categoryFilter').addEventListener('change', () => {
            renderProducts();
            updateUI();
        });
        document.getElementById('searchProduct').addEventListener('input', () => {
            renderProducts();
            updateUI();
        });

        document.getElementById('saveToCartBtn').addEventListener('click', saveToCart);
        document.getElementById('clearFormBtn').addEventListener('click', clearForm);
        document.getElementById('clientName').addEventListener('input', updateUI);
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    }

    // ====== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–û–í–ê–†–û–í ======
    function renderProducts() {
        const container = document.getElementById('productsList');
        container.innerHTML = '';

        const category = document.getElementById('categoryFilter').value;
        const search = document.getElementById('searchProduct').value.trim().toLowerCase();

        const filtered = products.filter(p => {
            const matchCat = category === 'all' || p.category === category;
            const matchSearch = !search || p.name.toLowerCase().includes(search);
            return matchCat && matchSearch;
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div style="font-size:12px;color:#9ca3af;">–ü–æ –¥–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç</div>';
            return;
        }

        filtered.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';

            const info = document.createElement('div');
            info.className = 'product-info';
            info.innerHTML = `
                <div class="product-name">${product.name}</div>
                <div class="product-meta">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${formatCategoryLabel(product.category || '')}</div>
                <div class="product-price">${product.price} ‚Ç∏ / —à—Ç</div>
            `;

            const controls = document.createElement('div');
            controls.className = 'qty-controls';

            const minusBtn = document.createElement('button');
            minusBtn.type = 'button';
            minusBtn.className = 'qty-btn';
            minusBtn.textContent = '‚àí';
            minusBtn.addEventListener('click', () => changeQty(product.id, -1));

            const display = document.createElement('div');
            display.className = 'qty-display';
            display.id = `qty-${product.id}`;
            display.textContent = cart[product.id]?.qty || 0;

            const plusBtn = document.createElement('button');
            plusBtn.type = 'button';
            plusBtn.className = 'qty-btn';
            plusBtn.textContent = '+';
            plusBtn.addEventListener('click', () => changeQty(product.id, 1));

            controls.appendChild(plusBtn);
            controls.appendChild(display);
            controls.appendChild(minusBtn);

            card.appendChild(info);
            card.appendChild(controls);

            container.appendChild(card);
        });
    }

    function changeQty(productId, delta) {
        const product = products.find(p => p.id === productId);
        if (!product) return;

        if (!cart[productId]) {
            cart[productId] = { product, qty: 0 };
        }

        const newQty = cart[productId].qty + delta;
        if (newQty <= 0) {
            delete cart[productId];
        } else {
            cart[productId].qty = newQty;
        }

        const display = document.getElementById(`qty-${productId}`);
        if (display) {
            display.textContent = cart[productId]?.qty || 0;
        }

        renderCart();
        updateUI();
    }

    // ====== –ö–û–†–ó–ò–ù–ê –ù–ê –ì–õ–ê–í–ù–û–ô ======
    function renderCart() {
        const container = document.getElementById('cartList');
        container.innerHTML = '';

        const entries = Object.values(cart);
        if (entries.length === 0) {
            container.innerHTML = '<div class="cart-empty">–¢–æ–≤–∞—Ä—ã –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.</div>';
            document.getElementById('cartSummary').style.display = 'none';
            return;
        }

        entries.forEach(item => {
            const { product, qty } = item;
            const line = document.createElement('div');
            line.className = 'cart-item';

            const main = document.createElement('div');
            main.className = 'cart-item-main';
            main.innerHTML = `
                <span class="cart-item-name">${product.name}</span>
                <span class="cart-item-meta">${qty} —à—Ç</span>
            `;

            const actions = document.createElement('div');
            actions.className = 'cart-item-actions';

            const price = document.createElement('div');
            price.className = 'cart-item-price';
            price.textContent = (qty * product.price).toLocaleString('ru-RU') + ' ‚Ç∏';

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'cart-delete';
            delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            delBtn.addEventListener('click', () => {
                delete cart[product.id];
                const display = document.getElementById(`qty-${product.id}`);
                if (display) display.textContent = 0;
                renderCart();
                updateUI();
            });

            actions.appendChild(price);
            actions.appendChild(delBtn);

            line.appendChild(main);
            line.appendChild(actions);

            container.appendChild(line);
        });

        document.getElementById('cartSummary').style.display = 'flex';
    }

    function calcTotals() {
        let totalAmount = 0;
        let totalItems = 0;
        let totalQty = 0;

        Object.values(cart).forEach(({ product, qty }) => {
            totalItems += 1;
            totalAmount += qty * product.price;
            totalQty += qty;
        });

        return { totalAmount, totalItems, totalQty };
    }

    function updateUI() {
        const { totalAmount, totalItems, totalQty } = calcTotals();

        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('totalAmount').textContent = totalAmount.toLocaleString('ru-RU');
        document.getElementById('totalQty').textContent = totalQty;

        const hasClient = document.getElementById('clientName').value.trim().length > 0;
        const hasItems = Object.keys(cart).length > 0;

        document.getElementById('saveToCartBtn').disabled = !(hasClient && hasItems);
    }

    // ====== –°–û–•–†–ê–ù–ï–ù–ò–ï –ó–ê–Ø–í–ö–ò –í –ö–û–†–ó–ò–ù–£ ======
    function saveToCart() {
        const orderData = collectOrderData();
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏
        const orderId = currentDraftId || Date.now().toString();
        
        const draftOrder = {
            id: orderId,
            ...orderData,
            status: 'draft',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        const draftOrders = getDraftOrders();
        
        if (currentDraftId) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞—è–≤–∫—É
            const index = draftOrders.findIndex(o => o.id === currentDraftId);
            if (index !== -1) {
                draftOrders[index] = draftOrder;
            }
        } else {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
            draftOrders.push(draftOrder);
        }
        
        saveDraftOrders(draftOrders);
        loadDraftOrders();
        clearForm();
        
        alert('–ó–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É!');
    }

    function clearForm() {
        document.getElementById('clientName').value = '';
        document.getElementById('clientCode').value = '';
        document.getElementById('clientAddress').value = '';
        document.getElementById('comment').value = '';
        
        // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
        Object.keys(cart).forEach(productId => {
            delete cart[productId];
            const display = document.getElementById(`qty-${productId}`);
            if (display) display.textContent = 0;
        });
        
        currentDraftId = null;
        renderCart();
        updateUI();
    }

    function collectOrderData() {
        const { totalAmount, totalItems, totalQty } = calcTotals();

        return {
            client: {
                name: document.getElementById('clientName').value.trim(),
                code: document.getElementById('clientCode').value.trim(),
                address: document.getElementById('clientAddress').value.trim()
            },
            delivery: {
                date: document.getElementById('deliveryDate').value,
                type: document.getElementById('deliveryType').value
            },
            items: Object.values(cart).map(({ product, qty }) => ({
                productId: product.id,
                name: product.name,
                qty,
                pricePerUnit: product.price,
                total: qty * product.price
            })),
            comment: document.getElementById('comment').value.trim(),
            totals: {
                amount: totalAmount,
                items: totalItems,
                quantity: totalQty
            },
            meta: {
                repName: document.getElementById('repName').textContent,
                chatId: tgUser?.id || null,
                username: tgUser?.username || null,
                tgInitData: tgInitData || null
            }
        };
    }

    // ====== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ß–ï–†–ù–û–í–ò–ö–û–í ======
    function loadDraftOrders() {
        const draftOrders = getDraftOrders();
        const container = document.getElementById('draftOrdersList');
        
        if (draftOrders.length === 0) {
            container.innerHTML = '<div class="cart-empty">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>';
            updateCartBadge();
            return;
        }

        container.innerHTML = '';
        
        draftOrders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'draft-order-card';
            
            const itemsText = order.items.map(item => `${item.name} (${item.qty} —à—Ç)`).join(', ');
            const date = new Date(order.createdAt).toLocaleDateString('ru-RU');
            
            card.innerHTML = `
                <div class="draft-order-header">
                    <div class="draft-order-title">${order.client.name}</div>
                    <div class="draft-order-date">${date}</div>
                </div>
                <div class="draft-order-client">
                    <strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.client.code || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                </div>
                <div class="draft-order-items">
                    <strong>–¢–æ–≤–∞—Ä—ã:</strong> ${itemsText.substring(0, 100)}${itemsText.length > 100 ? '...' : ''}
                </div>
                <div class="draft-order-items">
                    <strong>–°—É–º–º–∞:</strong> ${order.totals.amount.toLocaleString('ru-RU')} ‚Ç∏
                </div>
                <div class="draft-order-actions">
                    <button class="btn-secondary" onclick="editDraftOrder('${order.id}')">
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn-secondary" onclick="sendDraftOrder('${order.id}')">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                    <button class="btn-danger" onclick="deleteDraftOrder('${order.id}')">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        });
        
        updateCartBadge();
    }

    // ====== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ß–ï–†–ù–û–í–ò–ö–ê ======
    function editDraftOrder(orderId) {
        const draftOrders = getDraftOrders();
        const order = draftOrders.find(o => o.id === orderId);
        
        if (!order) return;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
        document.getElementById('clientName').value = order.client.name;
        document.getElementById('clientCode').value = order.client.code || '';
        document.getElementById('clientAddress').value = order.client.address || '';
        document.getElementById('deliveryDate').value = order.delivery.date;
        document.getElementById('deliveryType').value = order.delivery.type;
        document.getElementById('comment').value = order.comment || '';
        
        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ—Ä–∑–∏–Ω—É –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
        Object.keys(cart).forEach(productId => {
            delete cart[productId];
        });
        
        order.items.forEach(item => {
            cart[item.productId] = {
                product: {
                    id: item.productId,
                    name: item.name,
                    price: item.pricePerUnit
                },
                qty: item.qty
            };
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        renderProducts();
        renderCart();
        updateUI();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π ID —á–µ—Ä–Ω–æ–≤–∏–∫–∞
        currentDraftId = orderId;
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.nav-btn[data-screen="home"]').classList.add('active');
        document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
        document.getElementById('home-screen').classList.add('active');
        document.getElementById('screen-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏';
    }

    function deleteDraftOrder(orderId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
        
        const draftOrders = getDraftOrders();
        const filtered = draftOrders.filter(o => o.id !== orderId);
        saveDraftOrders(filtered);
        loadDraftOrders();
    }

    // ====== –û–¢–ü–†–ê–í–ö–ê –ß–ï–†–ù–û–í–ò–ö–ê ======
    async function sendDraftOrder(orderId) {
        const draftOrders = getDraftOrders();
        const order = draftOrders.find(o => o.id === orderId);
        
        if (!order) return;
        
        try {
            const res = await fetch(ORDER_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });

            if (!res.ok) {
                throw new Error('HTTP ' + res.status);
            }

            // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –∑–∞—è–≤–∫—É –≤ –∏—Å—Ç–æ—Ä–∏—é
            const historyOrders = getHistoryOrders();
            const orderWithStatus = {
                ...order,
                status: 'sent',
                sentAt: new Date().toISOString()
            };
            historyOrders.push(orderWithStatus);
            saveHistoryOrders(historyOrders);
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
            const filtered = draftOrders.filter(o => o.id !== orderId);
            saveDraftOrders(filtered);
            
            loadDraftOrders();
            loadHistoryOrders();
            
            alert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏:', err);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤–µ–±—Ö—É–∫–∞ n8n.');
        }
    }

    // ====== –ò–°–¢–û–†–ò–Ø –ó–ê–Ø–í–û–ö ======
    function loadHistoryOrders() {
        const historyOrders = getHistoryOrders();
        const container = document.getElementById('historyOrdersList');
        
        if (historyOrders.length === 0) {
            container.innerHTML = '<div class="cart-empty">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>';
            return;
        }

        container.innerHTML = '';
        
        historyOrders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'history-order-card';
            
            const date = new Date(order.sentAt || order.createdAt).toLocaleDateString('ru-RU');
            const itemsCount = order.items.length;
            
            card.innerHTML = `
                <div class="history-order-status status-sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                <div class="draft-order-header">
                    <div class="draft-order-title">${order.client.name}</div>
                    <div class="draft-order-date">${date}</div>
                </div>
                <div class="history-order-details">
                    <div><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.client.code || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                    <div><strong>–¢–æ–≤–∞—Ä–æ–≤:</strong> ${itemsCount} –ø–æ–∑–∏—Ü–∏–π, ${order.totals.quantity} —à—Ç</div>
                    <div><strong>–°—É–º–º–∞:</strong> ${order.totals.amount.toLocaleString('ru-RU')} ‚Ç∏</div>
                </div>
                <div class="draft-order-actions">
                    <button class="btn-secondary" onclick="viewOrderDetails('${order.id}')">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    // ====== –ü–†–û–°–ú–û–¢–† –î–ï–¢–ê–õ–ï–ô –ó–ê–Ø–í–ö–ò ======
    function viewOrderDetails(orderId) {
        const historyOrders = getHistoryOrders();
        const order = historyOrders.find(o => o.id === orderId);
        
        if (!order) return;
        
        const modalContent = document.getElementById('modalContent');
        const date = new Date(order.sentAt || order.createdAt).toLocaleString('ru-RU');
        
        let itemsHtml = '';
        order.items.forEach(item => {
            itemsHtml += `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f3f4f6;">
                    <div>${item.name}</div>
                    <div>${item.qty} —à—Ç √ó ${item.pricePerUnit} ‚Ç∏ = ${item.total} ‚Ç∏</div>
                </div>
            `;
        });
        
        modalContent.innerHTML = `
            <div class="modal-section">
                <div class="modal-label">–ö–ª–∏–µ–Ω—Ç</div>
                <div class="modal-value">${order.client.name}</div>
            </div>
            
            <div class="modal-section">
                <div class="modal-label">–ò–ü —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏</div>
                <div class="modal-value">${order.client.code || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            </div>
            
            <div class="modal-section">
                <div class="modal-label">–†–ù</div>
                <div class="modal-value">${order.client.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            </div>
            
            <div class="modal-section">
                <div class="modal-label">–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏</div>
                <div class="modal-value">${order.delivery.date} (${getDeliveryTypeText(order.delivery.type)})</div>
            </div>
            
            <div class="modal-section">
                <div class="modal-label">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</div>
                <div class="modal-value">${date}</div>
            </div>
            
            <div class="modal-section">
                <div class="modal-label">–¢–æ–≤–∞—Ä—ã</div>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${itemsHtml}
                </div>
            </div>
            
            <div class="modal-section">
                <div class="modal-label">–ò—Ç–æ–≥–æ</div>
                <div class="modal-value">${order.totals.items} –ø–æ–∑–∏—Ü–∏–π, ${order.totals.quantity} —à—Ç, ${order.totals.amount.toLocaleString('ru-RU')} ‚Ç∏</div>
            </div>
            
            ${order.comment ? `
            <div class="modal-section">
                <div class="modal-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
                <div class="modal-value">${order.comment}</div>
            </div>
            ` : ''}
        `;
        
        document.getElementById('orderDetailsModal').classList.add('active');
    }

    function getDeliveryTypeText(type) {
        const types = {
            'today': '–í –¥–µ–Ω—å',
            'tomorrow': '–ù–∞ –∑–∞–≤—Ç—Ä–∞',
            'schedule': '–ü–æ –≥—Ä–∞—Ñ–∏–∫—É'
        };
        return types[type] || type;
    }

    function closeModal() {
        document.getElementById('orderDetailsModal').classList.remove('active');
    }
</script>
</body>
</html>
